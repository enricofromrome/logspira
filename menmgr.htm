<!DOCTYPE HTML>
<html lang="en">
<head>
<title>edb 2019</title>
<meta name="theme-color" content="#7E7EFB"/>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta name="Description" content="Author: Enrico de Bernart, Category: Progressive Web App">
<link rel="manifest" href="manifest.json"> 
<meta charset="UTF-8">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="36x36" href="launcher-icon-0-75x.png">
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<style>
body {margin:0;font-size: 1em; /* 30px/16=1.875em */
    user-select: none; /* Standard syntax */
}
button {font-size: 2em; /* 30px/16=1.875em */}
.sopra {display: none;
position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
overflow-y: auto;
background-color:red;
}
      input { background-color:white; color:blue;  font:14px courier new; border:3px outset gold; }
      input:focus {background-color:yellow; color:red; }
      select { background-color:white; color:blue;  font:14px courier new; border:3px outset gold; }
      select:focus {background-color:yellow; color:red; }
      
form.html5-form {
  max-width: 350px;
}

.indice { background-color:#ffffff; color:blue;  font:24 px monospace;
width: 95%;max-width: 350px;
    height: 180px;padding-top: 0px; padding-bottom: 0px;white-space: nowrap;
    overflow-y: scroll;
    overflow-x:hidden;cursor:pointer
}

</style>
<script>
function ricp(che){
f=params.substr(che.length+params.indexOf(che))+"&"
r=f.substr(0,f.indexOf("&"))
if(params.indexOf(che)==-1){r=""}
return r
}
const params = window.location.hash.substr(1);  
var menu = ricp("menu=");
const specchio = ricp("me=");
 if (top===null){papa=opener} else {papa=top}
var m=[];m[0]= ["menu 0", "descr 1", "img(opt) 2", "X 3", "Y 4", "dX 5", "dY 6", "FG 7", "BG 8", "actn 9"]
if (specchio!==""){var zm=papa.sys.menu;m=zm}else{var zm=papa.sys.d[1][papa.sys.c[1]][0][4]
for(k=1;k<zm.length;k ++){m[k]=[];for(cl=1;cl<zm[k].length;cl++){m[k][cl-1]=zm[k][cl]}}}
if (!menu){menu=m[1][0]}
telef=papa.telef
// m=struttura menu
babbo=1;qbab=papa.sys.c[1]
possmen=[];pm=","
for(k=1;k<m.length;k ++){
pp=m[k][0]
t=pp.toString()
if (pm.search(t)<0){pm+=t+",";possmen.push(t)}
}

var j = 0; 
function counterImg() { j++; return j; }
function carica(chi,quale){
questo=m[chi]
console.log("caricato "+chi + " "+Date.now())
ctx.drawImage(promesse[quale],questo[3], questo[4], questo[5],questo[6])
}


function carimm(files){
for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var count = counterImg()-1;
        
        setTimeout((function (preview, surface, count) {
            return function (e) {
            promesse[count] = new Image()
            promesse[count].src=m[files[count]][2]
            promesse[count].onload = function() {carica(files[count],count)}
            console.log("Scoped " + files[count]);    
            }
        })(0, 0, count), 5);

}}

</script>
</head>
<body>
<table border="0" style="position: sticky;color:white;background-color: #C43;width:100%; max-width: 400px;top: 0px;right:1;border-style: none;"><tbody><tr>
  <td id="b1" style="color:white;background-color: blue;font-size: 32px; text-align: center" width="20%" onclick="bott(1)">⟱</td>
  <td id="b2" style="color:white;background-color: black;font-size: 32px; text-align: center" width="20%" onclick="bott(2)">⤨</td>
  <td id="b3" style="color:white;background-color: #666;font-size: 32px; text-align: center" width="20%" onclick="menuc(-1)">⤆</td>
  <td id="b4" style="color:white;background-color: #666;font-size: 32px; text-align: center" width="20%" onclick="menuc(1)">⤇</td>
  <td style="color:white;background-color: #f86;font-size: 32px; text-align: center"    onclick="nascondi()" width="20%">X</td>
  
  </tr></tbody></table>
<canvas id="canvas" width="360px" height="510px"></canvas><br>


<script>
topo=0
tcx0=0;tcy0=0
  var canvas = document.getElementById('canvas')
        ctx = canvas.getContext('2d')
//sensore touchpad------------------------------------------------------
canvas.addEventListener("touchstart",function(event){event.preventDefault();tcx0=event.touches[0].clientX;tcy0=event.touches[0].clientY;ct=0;start = Date.now();clickcanv(tcx0,tcy0)},{passive: false});

canvas.addEventListener("touchmove",function(event) {event.preventDefault();
tcx1=event.touches[0].clientX;tcy1=event.touches[0].clientY;
ctx.strokeStyle="#ffaa00";ctx.strokeRect(tcx1+tcx0,tcy1+tcy0,m[chi][5],m[chi][6])
//console.log(event.touches[0].force + " " + event.touches[0].clientX +" "+event.touches[0].clientY+ " " + (Date.now() - start))

if (event.touches.length>1){
ctx.fillStyle="#00ffaa";ctx.fillRect(event.touches[1].clientX,event.touches[1].clientY,event.touches[1].force*10,2)
}
},{passive: false});
canvas.addEventListener("touchend", function(event){event.preventDefault();
m[chi][3]=tcx1+tcx0;m[chi][4]=tcy1+tcy0;
if (specchio=="true"){top.sys.menu[chi][3]=tcx1+tcx0;top.sys.menu[chi][4]=tcy1+tcy0;}else{top.sys.d[babbo][qbab][0][4][chi][4]=tcx1+tcx0;top.sys.d[babbo][qbab][0][4][chi][5]=tcy1+tcy0;}

camb();disegna(menu)
},{passive: false});
//sensore mouse------------------------------------------------------
canvas.addEventListener("mousedown",function(event){event.preventDefault();
if (topo==0){tcx0=event.clientX;tcy0=event.clientY;ct=0;start = Date.now();clickcanv(tcx0,tcy0)}
topo=1},{passive: false});

canvas.addEventListener("mousemove",function(event) {event.preventDefault();
tcx1=event.clientX+tcx0;tcy1=event.clientY+tcy0;
if (topo==1){
ctx.strokeStyle="#ffaa00";ctx.strokeRect(tcx1,tcy1,m[chi][5],m[chi][6])
}
},{passive: false});
canvas.addEventListener("mouseup", function(event){event.preventDefault();tcx1=event.clientX+tcx0;tcy1=event.clientY+tcy0;
topo=0;if (specchio=="true"){top.sys.menu[chi][3]=tcx1;top.sys.menu[chi][4]=tcy1;}else{m[chi][3]=tcx1;m[chi][4]=tcy1;top.sys.d[babbo][qbab][0][4][chi][4]=tcx1;top.sys.d[babbo][qbab][0][4][chi][5]=tcy1;}
camb();disegna(menu)
},{passive: false});
//--------------------------------------------------------
  var img=document.createElement('img'); 
  imgs=[]     

promesse=[]

function nascondi(k){
f="menmgr.htm"+location.hash
fr="menmgr.htm#menu="+menu
if (specchio=="true"){fr="menmgr.htm#me=true&menu="+menu}
//if (screen.orientation.type[0]=="p"){
if(top.telef==1){
if (k==1){top.chiudi(f,1,fr)}else{top.chiudi(f)}
} else {window.close()}
}

function camb(){top.slv.style.backgroundColor="Tomato"}
//___________________________disegna_________________
function disegna(qq){
j=0
  q=qq
imgs=[]
promesse=[]
ctx.clearRect(0, 0, canvas.width, canvas.height)
ctx.fillStyle = "#000"
ctx.globalAlpha=0.8;
ctx.shadowBlur=8;
ctx.shadowOffsetX=3;
ctx.shadowOffsetY=3;
ctx.shadowColor="black";
ctx.lineCap="round"

for (var r = 1, n = m.length; r < n; r++) {
questo= m[r]
if(questo[0]==q){
ctx.globalAlpha=.4
ctx.fillStyle = questo[8]
larg=questo[5];lung=questo[6]
if(isNaN(questo[5])){pc=questo[5];larg=eval(pc.substr(0,pc.length-1)*window.innerWidth/100)}
if(questo[5]<0){pc=questo[5]*-1;larg=pc*window.innerWidth/100}
if(isNaN(questo[6])){pc=questo[6];lung=eval(pc.substr(0,pc.length-1)*window.innerHeight/100)}
if(questo[6]<0){pc=questo[6]*-1;lung=pc*window.innerHeight/100}
ctx.fillRect(questo[3], questo[4], larg,lung)
ctx.globalAlpha=1
ctx.font = "1.4em serif"
ctx.fillStyle = questo[7]
homen=""
if(questo[1]!=undefined){homen=questo[1]}
ctx.fillText(homen, questo[3],(questo[4] * 1)+22,larg)


if(questo[2]!=undefined ){imgs.push(r) }
}}
carimm(imgs)
}


//_________________________scelto una cosa_______________________
function clickcanv(x,y)
{chi=0
co=m
for (var r = 1, n = co.length; r < n; r++) {
if (co[r][0]==menu){
questo=co[r]
larg=co[r][5]*1;lung=co[r][6]*1
if(isNaN(questo[5])){pc=questo[5];larg=eval(pc.substr(0,pc.length-1)*window.innerWidth/100)}
if(questo[5]<0){pc=questo[5]*-1;larg=pc*window.innerWidth/100}
if(isNaN(questo[6])){pc=questo[6];lung=eval(pc.substr(0,pc.length-1)*window.innerHeight/100)}
if(questo[6]<0){pc=questo[6]*-1;lung=pc*window.innerHeight/100}

questo= co[r]
dax=questo[3]*1;finx=dax+larg
day=questo[4]*1+canvas.offsetTop;finy=day+lung
if (x>=dax && x<=finx && y>=day && y<=finy){chi=r}
}}

if (chi){
tcx0=m[chi][3]-tcx0
tcy0=m[chi][4]-tcy0
if (document.getElementById("b1").style.backgroundColor=="blue"){
sd="legdb2.htm";
if (specchio=="true"){sd=sd+"#arc=menu&questo="+chi}else
{sd=sd+"#arc=4&questo="+chi+"&babbo="+babbo+"&qbab="+qbab}

top.apri(sd)
nascondi(1)
}}
}

function bott(x){
document.getElementById("b1").style.backgroundColor="black" 
document.getElementById("b2").style.backgroundColor="black"
if (x==1){document.getElementById("b1").style.backgroundColor="blue"} 
if (x==2){document.getElementById("b2").style.backgroundColor="blue"} 
}
function menuc(z){
zz=z+possmen.findIndex(function(a){return a==menu})
if (zz>=possmen.length){zz=possmen.length-1}
if (zz<0){zz=0}
menu=possmen[zz]
disegna(menu)
}

</script>


</body>
<script>
window.onload = function() {
document.getElementById('canvas').width=window.innerWidth-8
document.getElementById('canvas').height=window.innerHeight-(8+canvas.offsetTop)
disegna(menu)
}
</script>
</html>
